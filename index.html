<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <title>那抓的图书馆</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/index.css">
</head>

<body>

    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-custom px-4">
        <h2 class="mb-0 mr-4">📚| 电子书下载</h2>

        <!-- 搜索框 -->
        <div class="form-inline mx-auto">
            <input id="search-keyword" class="form-control mr-sm-2" type="search" placeholder="搜索图书">
            <button id="search-btn" class="btn btn-outline-light my-2 my-sm-0" type="submit">搜索</button>
        </div>

        <!-- 导航菜单 -->
        <ul class="navbar-nav ml-auto" id="nav-menu"></ul>
    </nav>

    <!-- 图书列表 -->
    <div class="container mt-4">
        <div class="row" id="book-list"></div>
    </div>

    <!-- Bootstrap 4 脚本 -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        $(function () {
            let loggedIn = false; // 全局保存登录状态
            // 渲染导航栏
            function loadNav() {
                $.ajax({
                    url: './php/shouye.php',
                    type: 'POST',
                    dataType: 'json',
                    success: function (data) {
                        loggedIn = data.loggedIn;  // ✅ 保存登录状态
                        let navHtml = '';

                        if (data.loggedIn) {

                            // 公共部分
                            let menuItems = `
                                <a class="dropdown-item" href="mypage.html">个人主页</a>
                                <a class="dropdown-item" href="upload.html">上传图书</a>
                            `;

                            // 如果是管理员，加一个「管理员页面」
                            if (data.is_admin == 1) {
                                menuItems = `
                                    <a class="dropdown-item" href="admin.html">管理员页面</a>
                                    ${menuItems}
                                `;
                            }
                            navHtml = `
                                <li class="nav-item dropdown">
                                    <a class="nav-link dropdown-toggle" href="#" data-toggle="dropdown">
                                        ${data.email}
                                    </a>
                                    <div class="dropdown-menu dropdown-menu-right">
                                        ${menuItems}
                                        <div class="dropdown-divider"></div>
                                        <a class="dropdown-item" href="#" id="logout-btn">退出登录</a>
                                    </div>
                                </li>`;
                        } else {
                            navHtml = `<li class="nav-item"><a class="nav-link" href="login.html">登录</a></li>`;
                        }
                        $('#nav-menu').html(navHtml);
                    },
                    error: function () {
                        alert('加载导航栏失败');
                    }
                });
            }

            // 渲染图书
            function loadBooks(keyword = '') {
                $.ajax({
                    url: './php/shouye.php',
                    type: 'POST',
                    dataType: 'json',
                    data: { keyword: keyword },
                    success: function (data) {
                        let booksHtml = '';
                        if (data.books.length > 0) {
                            data.books.forEach(book => {
                                booksHtml += `
                                <div class="col-md-2 mb-4">
                                    <div class="card h-100 shadow-sm">
                                        <a href="#" class="book-link" data-id="${book.id}">
                                            <img src="ziyuan/images/${book.pic}" class="card-img-top">
                                        </a>
                                        <div class="card-body d-flex flex-column">
                                            <h6 class="card-title">
                                                <a href="#" class="book-link" data-id="${book.id}">${book.title}</a>
                                            </h6>
                                        </div>
                                    </div>
                                </div>`;
                            });
                        } else {
                            booksHtml = '<p>没有找到图书</p>';
                        }
                        $('#book-list').html(booksHtml);
                    },
                    error: function () {
                        alert('加载图书失败');
                    }
                });
            }

            // 点击图书（封面或标题）
            $(document).on('click', '.book-link', function (e) {
                e.preventDefault(); // 阻止默认跳转
                const bookId = $(this).data('id');

                if (!loggedIn) {
                    alert('请先登录才能查看书籍详情！');
                    return;
                }

                // 已登录，跳转
                window.location.href = 'book_info.html?id=' + bookId;
            });

            // 页面加载时，先加载导航栏，再加载图书
            loadNav();
            loadBooks();

            // 搜索按钮
            $('#search-btn').click(function () {
                loadBooks($('#search-keyword').val().trim());
            });

            // 回车搜索
            $('#search-keyword').keypress(function (e) {
                if (e.which === 13) $('#search-btn').click();
            });

            // 输入框清空时显示全部图书
            $('#search-keyword').on('input', function () {
                if ($(this).val().trim() === '') loadBooks();
            });

            // 退出登录
            $(document).on('click', '#logout-btn', function (e) {
                e.preventDefault();
                $.ajax({
                    url: 'php/logout.php',
                    type: 'POST',
                    dataType: 'json',
                    success: function (data) {
                        if (data.success) {
                            loadNav();   // 刷新导航栏
                            loadBooks(); // 刷新书籍
                        }
                    },
                    error: function () {
                        alert('退出登录失败');
                    }
                });
            });

        });
    </script>

</body>

</html>