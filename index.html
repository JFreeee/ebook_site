<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <title>é‚£æŠ“çš„å›¾ä¹¦é¦†</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/index.css">
</head>

<body>

    <!-- å¯¼èˆªæ  -->
    <nav class="navbar navbar-expand-lg navbar-custom px-4">
        <h2 class="mb-0 mr-4">ğŸ“š| ç”µå­ä¹¦ä¸‹è½½</h2>

        <!-- æœç´¢æ¡† -->
        <div class="form-inline mx-auto">
            <input id="search-keyword" class="form-control mr-sm-2" type="search" placeholder="æœç´¢å›¾ä¹¦">
            <button id="search-btn" class="btn btn-outline-light my-2 my-sm-0" type="submit">æœç´¢</button>
        </div>

        <!-- å¯¼èˆªèœå• -->
        <ul class="navbar-nav ml-auto" id="nav-menu"></ul>
    </nav>

    <!-- å›¾ä¹¦åˆ—è¡¨ -->
    <div class="container mt-4">
        <div class="row" id="book-list"></div>
    </div>

    <!-- Bootstrap 4 è„šæœ¬ -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        $(function () {
            let loggedIn = false; // å…¨å±€ä¿å­˜ç™»å½•çŠ¶æ€
            // æ¸²æŸ“å¯¼èˆªæ 
            function loadNav() {
                $.ajax({
                    url: './php/shouye.php',
                    type: 'POST',
                    dataType: 'json',
                    success: function (data) {
                        loggedIn = data.loggedIn;  // âœ… ä¿å­˜ç™»å½•çŠ¶æ€
                        let navHtml = '';

                        if (data.loggedIn) {

                            // å…¬å…±éƒ¨åˆ†
                            let menuItems = `
                                <a class="dropdown-item" href="mypage.html">ä¸ªäººä¸»é¡µ</a>
                                <a class="dropdown-item" href="upload.html">ä¸Šä¼ å›¾ä¹¦</a>
                            `;

                            // å¦‚æœæ˜¯ç®¡ç†å‘˜ï¼ŒåŠ ä¸€ä¸ªã€Œç®¡ç†å‘˜é¡µé¢ã€
                            if (data.is_admin == 1) {
                                menuItems = `
                                    <a class="dropdown-item" href="admin.html">ç®¡ç†å‘˜é¡µé¢</a>
                                    ${menuItems}
                                `;
                            }
                            navHtml = `
                                <li class="nav-item dropdown">
                                    <a class="nav-link dropdown-toggle" href="#" data-toggle="dropdown">
                                        ${data.email}
                                    </a>
                                    <div class="dropdown-menu dropdown-menu-right">
                                        ${menuItems}
                                        <div class="dropdown-divider"></div>
                                        <a class="dropdown-item" href="#" id="logout-btn">é€€å‡ºç™»å½•</a>
                                    </div>
                                </li>`;
                        } else {
                            navHtml = `<li class="nav-item"><a class="nav-link" href="login.html">ç™»å½•</a></li>`;
                        }
                        $('#nav-menu').html(navHtml);
                    },
                    error: function () {
                        alert('åŠ è½½å¯¼èˆªæ å¤±è´¥');
                    }
                });
            }

            // æ¸²æŸ“å›¾ä¹¦
            function loadBooks(keyword = '') {
                $.ajax({
                    url: './php/shouye.php',
                    type: 'POST',
                    dataType: 'json',
                    data: { keyword: keyword },
                    success: function (data) {
                        let booksHtml = '';
                        if (data.books.length > 0) {
                            data.books.forEach(book => {
                                booksHtml += `
                                <div class="col-md-2 mb-4">
                                    <div class="card h-100 shadow-sm">
                                        <a href="#" class="book-link" data-id="${book.id}">
                                            <img src="ziyuan/images/${book.pic}" class="card-img-top">
                                        </a>
                                        <div class="card-body d-flex flex-column">
                                            <h6 class="card-title">
                                                <a href="#" class="book-link" data-id="${book.id}">${book.title}</a>
                                            </h6>
                                        </div>
                                    </div>
                                </div>`;
                            });
                        } else {
                            booksHtml = '<p>æ²¡æœ‰æ‰¾åˆ°å›¾ä¹¦</p>';
                        }
                        $('#book-list').html(booksHtml);
                    },
                    error: function () {
                        alert('åŠ è½½å›¾ä¹¦å¤±è´¥');
                    }
                });
            }

            // ç‚¹å‡»å›¾ä¹¦ï¼ˆå°é¢æˆ–æ ‡é¢˜ï¼‰
            $(document).on('click', '.book-link', function (e) {
                e.preventDefault(); // é˜»æ­¢é»˜è®¤è·³è½¬
                const bookId = $(this).data('id');

                if (!loggedIn) {
                    alert('è¯·å…ˆç™»å½•æ‰èƒ½æŸ¥çœ‹ä¹¦ç±è¯¦æƒ…ï¼');
                    return;
                }

                // å·²ç™»å½•ï¼Œè·³è½¬
                window.location.href = 'book_info.html?id=' + bookId;
            });

            // é¡µé¢åŠ è½½æ—¶ï¼Œå…ˆåŠ è½½å¯¼èˆªæ ï¼Œå†åŠ è½½å›¾ä¹¦
            loadNav();
            loadBooks();

            // æœç´¢æŒ‰é’®
            $('#search-btn').click(function () {
                loadBooks($('#search-keyword').val().trim());
            });

            // å›è½¦æœç´¢
            $('#search-keyword').keypress(function (e) {
                if (e.which === 13) $('#search-btn').click();
            });

            // è¾“å…¥æ¡†æ¸…ç©ºæ—¶æ˜¾ç¤ºå…¨éƒ¨å›¾ä¹¦
            $('#search-keyword').on('input', function () {
                if ($(this).val().trim() === '') loadBooks();
            });

            // é€€å‡ºç™»å½•
            $(document).on('click', '#logout-btn', function (e) {
                e.preventDefault();
                $.ajax({
                    url: 'php/logout.php',
                    type: 'POST',
                    dataType: 'json',
                    success: function (data) {
                        if (data.success) {
                            loadNav();   // åˆ·æ–°å¯¼èˆªæ 
                            loadBooks(); // åˆ·æ–°ä¹¦ç±
                        }
                    },
                    error: function () {
                        alert('é€€å‡ºç™»å½•å¤±è´¥');
                    }
                });
            });

        });
    </script>

</body>

</html>